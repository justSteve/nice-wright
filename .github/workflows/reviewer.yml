name: Reviewer - PR Gate

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, ready_for_review]
  
  # Also trigger when task status changes to "review"
  push:
    branches:
      - main
    paths:
      - '_meta/tasks/*.json'

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  META_DIR: '_meta'

jobs:
  # ============================================================
  # JOB 1: Validate PR from agent branch
  # ============================================================
  review-pr:
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'agent/')
    runs-on: ubuntu-latest
    outputs:
      task_id: ${{ steps.extract.outputs.task_id }}
      review_decision: ${{ steps.review.outputs.decision }}
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract task ID
        id: extract
        run: |
          BRANCH="${{ github.head_ref }}"
          TASK_ID="${BRANCH#agent/}"
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "Reviewing PR for task: $TASK_ID"
      
      - name: Checkout main for task metadata
        uses: actions/checkout@v4
        with:
          ref: main
          path: main-branch
      
      - name: Load task requirements
        id: load-task
        run: |
          TASK_ID="${{ steps.extract.outputs.task_id }}"
          TASK_FILE="main-branch/$META_DIR/tasks/${TASK_ID}.json"
          
          if [ ! -f "$TASK_FILE" ]; then
            echo "::error::Task file not found: $TASK_FILE"
            exit 1
          fi
          
          # Extract requirements
          DESCRIPTION=$(jq -r '.requirements.description' "$TASK_FILE")
          CRITERIA=$(jq -r '.requirements.acceptance_criteria | @json' "$TASK_FILE")
          FILES_EXPECTED=$(jq -r '.requirements.files_to_modify // [] | @json' "$TASK_FILE")
          
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "criteria=$CRITERIA" >> $GITHUB_OUTPUT
          echo "files_expected=$FILES_EXPECTED" >> $GITHUB_OUTPUT
      
      - name: Check CI status
        id: ci-check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get CI check status for this PR
          CI_STATUS=$(gh pr checks ${{ github.event.pull_request.number }} --json name,state \
            --jq '[.[] | select(.name != "review-pr")] | map(.state) | if all(. == "SUCCESS") then "passed" else "failed" end')
          
          echo "ci_status=$CI_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$CI_STATUS" != "passed" ]; then
            echo "CI checks not all passing"
          fi
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in PR
          CHANGED=$(git diff --name-only origin/main...HEAD | jq -R -s 'split("\n") | map(select(length > 0))')
          echo "changed_files=$CHANGED" >> $GITHUB_OUTPUT
      
      - name: Validate file coverage
        id: file-check
        run: |
          EXPECTED='${{ steps.load-task.outputs.files_expected }}'
          CHANGED='${{ steps.changed-files.outputs.changed_files }}'
          
          # Check if expected files were modified
          MISSING_FILES=""
          for FILE in $(echo "$EXPECTED" | jq -r '.[]'); do
            if ! echo "$CHANGED" | jq -e --arg f "$FILE" 'index($f)' > /dev/null; then
              MISSING_FILES="$MISSING_FILES $FILE"
            fi
          done
          
          if [ -n "$MISSING_FILES" ]; then
            echo "missing_files=$MISSING_FILES" >> $GITHUB_OUTPUT
            echo "files_valid=false" >> $GITHUB_OUTPUT
          else
            echo "files_valid=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate PR summary
        id: summarize
        run: |
          # Get diff for analysis
          DIFF=$(git diff origin/main...HEAD --stat)
          DIFF_CONTENT=$(git diff origin/main...HEAD)
          
          # Create a summary of changes
          cat > pr-summary.md << EOF
          ## Changes Summary
          
          \`\`\`
          $DIFF
          \`\`\`
          
          ### Files Changed
          $(echo '${{ steps.changed-files.outputs.changed_files }}' | jq -r '.[] | "- " + .')
          
          ### Acceptance Criteria Check
          
          **Required criteria:**
          $(echo '${{ steps.load-task.outputs.criteria }}' | jq -r '.[] | "- [ ] " + .')
          
          EOF
          
          echo "Generated PR summary"
      
      - name: Perform automated review
        id: review
        run: |
          # ================================================================
          # REVIEW DECISION LOGIC
          # This is deterministic - no LLM needed for basic checks
          # ================================================================
          
          DECISION="APPROVE"
          FEEDBACK=""
          
          # Check 1: CI must pass
          if [ "${{ steps.ci-check.outputs.ci_status }}" != "passed" ]; then
            DECISION="REQUEST_CHANGES"
            FEEDBACK="$FEEDBACK\n- CI checks are not passing"
          fi
          
          # Check 2: Expected files should be modified
          if [ "${{ steps.file-check.outputs.files_valid }}" != "true" ]; then
            DECISION="COMMENT"
            FEEDBACK="$FEEDBACK\n- Expected files not modified: ${{ steps.file-check.outputs.missing_files }}"
          fi
          
          # Check 3: No secrets in diff
          if git diff origin/main...HEAD | grep -iE '(api[_-]?key|password|secret|token)\s*[:=]' | grep -v '\.example\|\.sample\|placeholder'; then
            DECISION="REQUEST_CHANGES"
            FEEDBACK="$FEEDBACK\n- Potential secrets detected in diff"
          fi
          
          # Check 4: No debug/console statements left
          if git diff origin/main...HEAD | grep -E '^\+.*console\.(log|debug|warn)\(' | grep -v '// allowed'; then
            DECISION="COMMENT"
            FEEDBACK="$FEEDBACK\n- Debug console statements found"
          fi
          
          echo "decision=$DECISION" >> $GITHUB_OUTPUT
          echo "feedback<<EOF" >> $GITHUB_OUTPUT
          echo -e "$FEEDBACK" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Submit review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK_ID="${{ steps.extract.outputs.task_id }}"
          DECISION="${{ steps.review.outputs.decision }}"
          FEEDBACK="${{ steps.review.outputs.feedback }}"
          
          REVIEW_BODY="## Automated Review - Task \`$TASK_ID\`

          **Decision:** $DECISION

          ### Checks Performed
          - [x] CI Status: ${{ steps.ci-check.outputs.ci_status }}
          - [x] Expected Files Modified: ${{ steps.file-check.outputs.files_valid }}
          - [x] No Secrets in Diff
          - [x] No Debug Statements

          ### Feedback
          $FEEDBACK

          ---
          _Review performed by reviewer-bot at $(date -u +%Y-%m-%dT%H:%M:%SZ)_"
          
          # Submit the review
          if [ "$DECISION" = "APPROVE" ]; then
            gh pr review ${{ github.event.pull_request.number }} --approve --body "$REVIEW_BODY"
          elif [ "$DECISION" = "REQUEST_CHANGES" ]; then
            gh pr review ${{ github.event.pull_request.number }} --request-changes --body "$REVIEW_BODY"
          else
            gh pr review ${{ github.event.pull_request.number }} --comment --body "$REVIEW_BODY"
          fi

  # ============================================================
  # JOB 2: Update task review status
  # ============================================================
  update-review-status:
    needs: review-pr
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      
      - name: Update task review metadata
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TASK_ID="${{ needs.review-pr.outputs.task_id }}"
          DECISION="${{ needs.review-pr.outputs.review_decision }}"
          TASK_FILE="$META_DIR/tasks/${TASK_ID}.json"
          
          if [ ! -f "$TASK_FILE" ]; then
            echo "Task file not found"
            exit 0
          fi
          
          # Map decision to status
          case "$DECISION" in
            "APPROVE")
              REVIEW_STATUS="approved"
              ;;
            "REQUEST_CHANGES")
              REVIEW_STATUS="changes_requested"
              ;;
            *)
              REVIEW_STATUS="pending"
              ;;
          esac
          
          # Update task file
          jq --arg reviewer "reviewer-${{ github.run_id }}" \
             --arg status "$REVIEW_STATUS" \
             --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
             '
             .review.reviewer_agent = $reviewer |
             .review.status = $status |
             .review.reviewed_at = $ts |
             if $status == "changes_requested" then .status = "in_progress" else . end
             ' "$TASK_FILE" > tmp.json && mv tmp.json "$TASK_FILE"
          
          git config user.name "reviewer-bot"
          git config user.email "reviewer@bot.local"
          git add "$TASK_FILE"
          git diff --staged --quiet || git commit -m "reviewer: update task $TASK_ID review status to $REVIEW_STATUS"
          git push

  # ============================================================
  # JOB 3: Trigger worker on changes requested
  # ============================================================
  trigger-worker-fix:
    needs: [review-pr, update-review-status]
    if: needs.review-pr.outputs.review_decision == 'REQUEST_CHANGES'
    runs-on: ubuntu-latest
    
    steps:
      - name: Dispatch worker to fix issues
        env:
          GITHUB_TOKEN: ${{ secrets.AGENT_PAT }}
        run: |
          TASK_ID="${{ needs.review-pr.outputs.task_id }}"

          echo "Review requested changes - triggering worker retry for task $TASK_ID"

          gh api repos/${{ github.repository }}/dispatches \
            -f event_type=worker_retry \
            -f client_payload="{\"task_id\":\"$TASK_ID\",\"reason\":\"review_changes_requested\"}"

  # ============================================================
  # JOB 4: Handle non-agent PRs (human PRs)
  # ============================================================
  review-human-pr:
    if: github.event_name == 'pull_request' && !startsWith(github.head_ref, 'agent/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
      
      - name: Basic validation for human PRs
        run: |
          echo "Human PR detected - performing basic validation only"
          
          # Basic checks without task context
          # 1. No obvious secrets
          if git diff origin/main...HEAD | grep -iE '(api[_-]?key|password|secret|token)\s*[:=]' | grep -v '\.example\|\.sample'; then
            echo "::warning::Potential secrets detected - please review"
          fi
          
          echo "Human PR validation complete"
      
      - name: Add informational comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if we already commented
          EXISTING=$(gh pr view ${{ github.event.pull_request.number }} --comments --json body --jq '.[] | select(.body | contains("Human PR Detected"))')
          
          if [ -z "$EXISTING" ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "## Human PR Detected

          This PR was not created by an agent workflow. Standard review processes apply.

          **Automated checks performed:**
          - Basic secret detection
          - CI workflow triggered separately

          _Please ensure a human reviewer approves this PR before merging._"
          fi
